<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Control de Gastos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        function toggleForms(tipo) {
            if(tipo === 'rapido') {
                document.getElementById('form-rapido').style.display = 'block';
                document.getElementById('form-factura').style.display = 'none';
            } else {
                document.getElementById('form-rapido').style.display = 'none';
                document.getElementById('form-factura').style.display = 'block';
            }
        }
    </script>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-danger mb-4 px-3">
    <a class="navbar-brand fs-3 fw-bold" href="#">üìâ Gastos Uma√±ita</a>
    <div class="ms-auto d-flex gap-2">
        <a href="{{ url_for('gastos.proveedores') }}" class="btn btn-light text-danger fw-bold">üöö Proveedores</a>
        <a href="{{ url_for('gastos.conceptos') }}" class="btn btn-warning text-dark fw-bold">‚öôÔ∏è Conceptos</a>
        <a href="/ventas" class="btn btn-outline-light">Volver al POS</a>
    </div>
</nav>

<div class="container pb-5">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="d-flex justify-content-center gap-3 mb-4">
        <button class="btn btn-outline-danger active" onclick="toggleForms('rapido')">üöÄ Gasto R√°pido</button>
        <button class="btn btn-outline-dark" onclick="toggleForms('factura')">üßæ Registrar Factura (M√∫ltiple)</button>
    </div>

    <div id="form-rapido" class="card shadow border-danger mb-4">
        <div class="card-header bg-danger text-white"><h5>Gasto Individual</h5></div>
        <div class="card-body">
            <form action="{{ url_for('gastos.index') }}" method="POST">
                <div class="row">
                    <div class="col-md-6">
                        <label class="fw-bold">Categor√≠a</label>
                        <select class="form-select mb-3" id="selCategoria" onchange="filtrarConceptos()" required>
                            <option value="">Seleccione...</option>
                            <option value="Materia Prima">Materia Prima</option>
                            <option value="Obligaciones Laborales">Obligaciones Laborales</option>
                            <option value="Servicios">Servicios</option>
                            <option value="Arriendo">Arriendo</option>
                            <option value="Otros Gastos">Otros Gastos</option>
                            <option value="Activos">Activos</option>
                        </select>
                        
                        <label class="fw-bold">Concepto</label>
                        <select class="form-select mb-3" name="concepto_id" id="selConcepto" required disabled onchange="checkNomina()">
                            <option value="">Elija categor√≠a...</option>
                            {% for c in conceptos %}
                                <option value="{{ c.id }}" data-cat="{{ c.categoria }}">{{ c.nombre }}</option>
                            {% endfor %}
                        </select>

                        <div id="div-nomina" class="mb-3 p-2 bg-info bg-opacity-10 border rounded" style="display:none;">
                            <label class="small fw-bold">Empleado:</label>
                            <select name="empleado_nomina" class="form-select form-select-sm">
                                <option value="">-- Seleccionar --</option>
                                {% for emp in empleados %}
                                    <option value="{{ emp }}">{{ emp }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <label class="fw-bold">Detalle / Descripci√≥n (Opcional)</label>
                        <input type="text" name="detalle_adicional" class="form-control mb-3" placeholder="Ej: Taxi a la plaza, Compra de bombillos...">
                    </div>

                    <div class="col-md-6">
                        <label class="fw-bold">M√©todo Pago</label>
                        <select class="form-select mb-2" name="metodo_pago" required>
                            <option value="Efectivo Caja">Efectivo</option>
                            <option value="Nequi">Nequi</option>
                            <option value="Daviplata">Daviplata</option>
                        </select>
                        <select class="form-select mb-3" name="origen_dinero">
                            <option value="Caja Menor">De Caja Menor (Diaria)</option>
                            <option value="Caja Mayor">De Caja Mayor (Fuerte)</option>
                        </select>

                        <label class="fw-bold text-danger">Valor ($)</label>
                        <input type="number" name="monto" class="form-control form-control-lg border-danger fw-bold mb-3" required>
                    </div>
                </div>
                
                <div class="p-2 mb-3 bg-light border rounded">
                    <small class="fw-bold text-success">üì¶ ¬øAfecta Inventario?</small>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" name="insumo_relacionado_id">
                            <option value="">No</option>
                            {% for i in insumos %}
                                <option value="{{ i.id }}">{{ i.nombre }}</option>
                            {% endfor %}
                        </select>
                        <input type="number" step="0.1" name="cantidad" class="form-control form-control-sm" placeholder="Cant." style="width: 80px;">
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" name="es_fantasma">
                    <label class="form-check-label text-muted">üëª Gasto Fantasma (Solo descuenta caja)</label>
                </div>

                <button type="submit" class="btn btn-danger w-100 fw-bold py-2">REGISTRAR GASTO</button>
            </form>
        </div>
    </div>

    <div id="form-factura" class="card shadow border-dark mb-4" style="display:none;">
        <div class="card-header bg-dark text-white"><h5>üßæ Registrar Factura Completa</h5></div>
        <div class="card-body">
            <form action="{{ url_for('gastos.factura_masiva') }}" method="POST">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label>Proveedor</label>
                        <select name="factura_proveedor" class="form-select">
                            <option value="">Varios / An√≥nimo</option>
                            {% for p in proveedores %}<option value="{{ p.id }}">{{ p.nombre }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>M√©todo Pago</label>
                        <select name="factura_metodo" class="form-select">
                            <option value="Efectivo Caja">Efectivo</option>
                            <option value="Nequi">Nequi</option>
                            <option value="Daviplata">Daviplata</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>Origen</label>
                        <select name="factura_origen" class="form-select">
                            <option value="Caja Menor">Caja Menor</option>
                            <option value="Caja Mayor">Caja Mayor</option>
                        </select>
                    </div>
                </div>

                <table class="table table-sm">
                    <thead><tr><th>Concepto</th><th>Descrip/Item</th><th>Subtotal</th><th>IVA</th><th></th></tr></thead>
                    <tbody id="tabla-factura">
                        </tbody>
                </table>
                <button type="button" class="btn btn-sm btn-secondary mb-3" onclick="agregarFilaFactura()">+ Agregar Item</button>
                <hr>
                <button type="submit" class="btn btn-dark w-100">GUARDAR FACTURA COMPLETA</button>
            </form>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-header">√öltimos Movimientos</div>
        <div class="card-body p-0 table-responsive">
            <table class="table table-hover mb-0 small align-middle">
                <thead class="table-light"><tr><th>Fecha</th><th>Desc</th><th>Pago</th><th>Monto</th><th></th></tr></thead>
                <tbody>
                    {% for g in gastos %}
                    <tr class="{{ 'table-secondary text-muted' if g.es_fantasma else '' }}">
                        <td>{{ g.fecha.strftime('%d/%m %H:%M') }}</td>
                        <td>
                            {% if g.es_fantasma %}üëª{% endif %}
                            <strong>{{ g.descripcion }}</strong><br>
                            <span class="text-muted" style="font-size: 0.85em;">{{ g.categoria }}</span>
                        </td>
                        <td>{{ g.metodo_pago }} <br> <span class="text-muted">({{ g.origen_dinero }})</span></td>
                        <td class="fw-bold text-danger">${{ "{:,.0f}".format(g.monto) }}</td>
                        <td><a href="{{ url_for('gastos.eliminar', id=g.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('¬øBorrar?');"><i class="fas fa-trash"></i></a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function filtrarConceptos() {
        const cat = document.getElementById('selCategoria').value;
        const select = document.getElementById('selConcepto');
        const opciones = select.querySelectorAll('option');
        select.disabled = false; select.value = "";
        opciones.forEach(opt => {
            if (opt.value === "") return;
            opt.style.display = (opt.dataset.cat === cat) ? 'block' : 'none';
        });
    }

    function checkNomina() {
        const select = document.getElementById('selConcepto');
        const cat = select.options[select.selectedIndex].dataset.cat;
        document.getElementById('div-nomina').style.display = (cat === 'Obligaciones Laborales') ? 'block' : 'none';
    }

    function agregarFilaFactura() {
        const tbody = document.getElementById('tabla-factura');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <select name="item_concepto" class="form-select form-select-sm" required>
                    {% for c in conceptos %}<option value="{{ c.id }}">{{ c.nombre }}</option>{% endfor %}
                </select>
            </td>
            <td><input type="text" name="item_desc" class="form-control form-control-sm" placeholder="Detalle"></td>
            <td><input type="number" name="item_subtotal" class="form-control form-control-sm" placeholder="$$" required></td>
            <td>
                <select name="item_iva_select" class="form-select form-select-sm">
                    <option value="0">0%</option>
                    <option value="5">5%</option>
                    <option value="19">19%</option>
                </select>
            </td>
            <td><button type="button" class="btn btn-link text-danger" onclick="this.closest('tr').remove()">X</button></td>
        `;
        tbody.appendChild(row);
    }
    // Iniciar con una fila
    if(document.getElementById('tabla-factura').children.length === 0) agregarFilaFactura();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>