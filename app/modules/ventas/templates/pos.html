<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>POS Uma√±ita</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-size: 1.1rem; background-color: #f0f2f5; height: 100vh; overflow: hidden; }
        
        /* Estilos Tablero Productos */
        .nav-pills .nav-link { 
            color: #495057; 
            font-weight: bold; 
            background-color: #fff; 
            border: 1px solid #dee2e6; 
            margin-right: 5px; 
            margin-bottom: 5px;
            border-radius: 20px;
            padding: 8px 16px;
            white-space: nowrap;
        }
        .nav-pills .nav-link.active { 
            background-color: #dc3545; /* Rojo Uma√±ita */
            color: white; 
            border-color: #dc3545; 
        }
        .tab-content { 
            height: calc(100vh - 160px); 
            overflow-y: auto; 
            padding-bottom: 50px; 
            padding-right: 5px;
        }

        /* Cards */
        .card-producto { cursor: pointer; transition: all 0.2s; border: none; background: white; border-radius: 12px; overflow: hidden; height: 100%; display: flex; flex-direction: column; border: 1px solid #e9ecef; }
        .card-producto:active { transform: scale(0.95); background-color: #ffe6e6; }
        .card-producto:hover { box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15); transform: translateY(-3px); border-color: #dc3545; }
        .precio-badge { font-size: 1.2rem; font-weight: 800; color: #dc3545; background: #fff0f0; padding: 2px 8px; border-radius: 8px; }
        .prod-img { width: 100%; height: 90px; object-fit: cover; border-radius: 8px; margin-bottom: 5px; }
        
        /* Panel Derecho (Carrito) */
        .total-display { font-size: 2.5rem; font-weight: 800; color: #2c3e50; text-align: right; letter-spacing: -1px; }
        .btn-cant { width: 30px; height: 30px; font-weight: bold; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; }
        
        /* Mesas */
        .mesa-btn { width: 100%; margin-bottom: 5px; font-weight: bold; text-align: left; padding-left: 15px; }
        .mesa-activa { background-color: #ffc107 !important; color: black !important; border-color: #e0a800 !important; }
        
        @media print {
                    @page {
                        /* CAMBIO CLAVE: Ajustado a 72mm para coincidir con tu impresora */
                        size: 72mm auto;   
                        margin: 0mm;       
                    }

                    body {
                        visibility: hidden;
                        margin: 0;
                        padding: 0;
                    }

                    #ticket-print, #ticket-print * {
                        visibility: visible;
                    }

                    #ticket-print {
                        position: absolute;
                        left: 0;
                        top: 0;
                        /* CAMBIO: Usamos 100% pero del ancho de p√°gina definido arriba (72mm) */
                        width: 100%;       
                        height: auto;      
                        
                        font-family: 'Arial', sans-serif;
                        font-weight: bold;
                        font-size: 12px;
                        color: black;
                        background: white;
                        display: block !important;
                        
                        /* CAMBIO: Margen derecho de seguridad para evitar cortes */
                        padding-right: 2mm; 
                        padding-bottom: 5mm; 
                    }

                    .modal, .navbar, .container-fluid { 
                        display: none !important; 
                    }
                }
                
                #ticket-print { display: none; }
    </style>
</head>
<body class="d-flex flex-column">

<nav class="navbar navbar-expand-lg navbar-dark bg-danger shadow-sm px-3 flex-shrink-0" style="height: 60px;">
    <a class="navbar-brand fw-bold" href="#">üçó Uma√±ita POS</a>
    <div class="ms-auto">
        <a href="{{ url_for('ventas.historial') }}" class="btn btn-sm btn-outline-light me-1">üìú Historial</a>
        {% if current_user.rol == 'admin' %}
            <a href="/productos" class="btn btn-sm btn-outline-light me-1">üçî Men√∫</a>
            <a href="{{ url_for('ventas.ingresos_otros') }}" class="btn btn-sm btn-outline-light me-1">üí∞ Ingresos</a>
            <a href="/gastos" class="btn btn-sm btn-outline-light me-1">üìâ Gastos</a>
            <a href="/inventario" class="btn btn-sm btn-outline-light me-1">üì¶ Bodega</a>
            <a href="/informes" class="btn btn-sm btn-outline-light me-1">üìä Informes</a>
        {% endif %}
        <a href="/gastos" class="btn btn-sm btn-warning fw-bold text-dark">üí∏ Gasto R√°pido</a>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-dark ms-2">Salir</a>
    </div>
</nav>

<div class="container-fluid flex-grow-1 p-3 overflow-hidden">
    <div class="row h-100">
        <div class="col-md-7 h-100 d-flex flex-column">
            <ul class="nav nav-pills mb-2 flex-nowrap overflow-auto py-1" id="pills-tab" role="tablist">
                {% for categoria, items in productos_por_categoria %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {{ 'active' if loop.first }}" 
                            id="pills-{{ loop.index }}-tab" 
                            data-bs-toggle="pill" 
                            data-bs-target="#pills-{{ loop.index }}" 
                            type="button" role="tab">
                        {{ categoria }}
                    </button>
                </li>
                {% endfor %}
            </ul>

            <div class="tab-content flex-grow-1" id="pills-tabContent">
                {% for categoria, items in productos_por_categoria %}
                <div class="tab-pane fade {{ 'show active' if loop.first }}" id="pills-{{ loop.index }}" role="tabpanel">
                    <div class="row g-2">
                        {% for p in items %}
                        <div class="col-md-3 col-sm-4 col-6">
                            <div class="card card-producto h-100 shadow-sm p-2 text-center btn-agregar-producto" 
                                 role="button" data-id="{{ p.id }}" data-nombre="{{ p.nombre }}" data-precio="{{ p.precio }}">
                                <div class="card-body p-0 d-flex flex-column justify-content-center align-items-center">
                                    {% if p.imagen_local %}
                                        <img src="{{ url_for('static', filename='uploads/' + p.imagen_local) }}" alt="{{ p.nombre }}" class="prod-img">
                                    {% endif %}
                                    <h6 class="card-title mb-1 fw-bold text-dark small lh-sm">{{ p.nombre }}</h6>
                                    <div class="precio-badge mt-auto">
                                        {% if p.precio > 0 %}
                                            ${{ "{:,.0f}".format(p.precio) }}
                                        {% else %}
                                            Variable
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="col-md-3 h-100 d-flex flex-column px-0">
            <div class="card shadow h-100 border-0 rounded-0 border-start border-end">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-2">
                    <h6 class="mb-0 small text-truncate" id="titulo-orden">Mesa: <span id="mesa-actual" class="fw-bold text-warning">Mostrador</span></h6>
                    <span class="badge bg-light text-dark" id="conteo-items">0</span>
                </div>
                <div class="card-body p-0 flex-grow-1 overflow-auto bg-white">
                    <table class="table table-striped table-sm align-middle mb-0">
                        <thead class="table-light sticky-top"><tr><th>Prod.</th><th class="text-center">Cant.</th><th class="text-end">Total</th><th></th></tr></thead>
                        <tbody id="tabla-carrito"></tbody>
                    </table>
                </div>
                <div class="card-footer bg-light p-2 border-top">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold text-muted">Total:</span>
                        <div id="total-pagar" class="fs-2 fw-bold text-dark">$0</div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <div class="row g-1">
                            <div class="col-6">
                                <button class="btn btn-primary w-100 py-2 fw-bold btn-sm" onclick="guardarEnMesa()">ü™ë GUARDAR</button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-danger w-100 py-2 btn-sm" onclick="limpiarCarrito()">üóëÔ∏è</button>
                            </div>
                        </div>
                        <button class="btn btn-success w-100 py-2 fw-bold fs-5" onclick="abrirModalPago()">COBRAR üíµ</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-2 h-100 overflow-auto bg-white border-start p-2">
            <small class="text-muted fw-bold text-uppercase d-block mb-2 text-center">Ubicaciones</small>
            <button class="btn btn-outline-secondary mesa-btn btn-sm" onclick="seleccionarMesa('Mostrador')"><i class="fas fa-walking me-2"></i> Mostrador</button>
            <button class="btn btn-outline-primary mesa-btn btn-sm mt-1" onclick="seleccionarMesa('Domicilio')"><i class="fas fa-motorcycle me-2"></i> Domicilio</button>
            <hr class="my-2">
            {% for i in range(1, 13) %}
            <button class="btn btn-outline-dark mesa-btn btn-sm" id="btn-mesa-{{i}}" onclick="seleccionarMesa('{{i}}')">Mesa {{ i }}</button>
            {% endfor %}
        </div>
    </div>
</div>

<div class="modal fade" id="modalPago" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h4 class="modal-title">üí∏ Finalizar Venta</h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 border-end">
                        <h5 class="text-success mb-3">üë§ Datos del Cliente</h5>
                        <div class="mb-2"><label class="small">Nombre</label><input type="text" id="cli-nombre" class="form-control" value="Consumidor Final"></div>
                        <div class="row g-2 mb-2">
                            <div class="col-6"><label class="small">NIT</label><input type="text" id="cli-nit" class="form-control" value="222222222222"></div>
                            <div class="col-6"><label class="small">Tel√©fono</label><input type="text" id="cli-tel" class="form-control"></div>
                        </div>
                        <div class="mb-2"><label class="small">Direcci√≥n</label><input type="text" id="cli-dir" class="form-control"></div>
                        
                        <div class="bg-light p-2 rounded border mt-3">
                            <label class="fw-bold text-danger">üéüÔ∏è Descuento ($)</label>
                            <input type="number" id="input-descuento" class="form-control" value="0" onkeyup="calcularVueltas()">
                        </div>
                        
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="checkFantasma">
                            <label class="form-check-label text-muted small" for="checkFantasma">üëª Venta Fantasma (Solo Caja)</label>
                        </div>
                    </div>

                    <div class="col-md-6 ps-4">
                        <div class="d-flex justify-content-between">
                            <label class="fw-bold">Subtotal:</label>
                            <span id="lbl-subtotal" class="fw-bold">$0</span>
                        </div>
                        <div class="d-flex justify-content-between text-danger">
                            <label>Descuento:</label>
                            <span id="lbl-descuento">-$0</span>
                        </div>
                        <hr>
                        <label class="fw-bold fs-4">Total a Pagar:</label>
                        <input type="text" id="modal-total" class="form-control form-control-lg fw-bold text-end bg-light mb-3" readonly style="font-size: 1.8rem;">
                        
                        <label class="text-primary">üíµ Efectivo Recibido:</label>
                        <input type="number" id="input-recibido" class="form-control form-control-lg fw-bold text-end border-primary mb-3" style="font-size: 1.5rem;" onkeyup="calcularVueltas()" placeholder="0">
                        
                        <div class="alert alert-secondary text-center py-2" id="info-vueltas">
                            <small>Vueltas / Cambio:</small><br><span class="fs-2 fw-bold text-dark" id="txt-vueltas">$0</span>
                        </div>
                        
                        <h6 class="border-top pt-2 mt-2">Otros M√©todos</h6>
                        <div class="row g-2">
                            <div class="col-6"><input type="number" id="pago-nequi" class="form-control" placeholder="Nequi" onkeyup="calcularVueltas()"></div>
                            <div class="col-6"><input type="number" id="pago-daviplata" class="form-control" placeholder="Daviplata" onkeyup="calcularVueltas()"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Volver</button>
                <button type="button" class="btn btn-primary btn-lg" onclick="cobrarVenta(false)">üíæ SOLO GUARDAR</button>
                <button type="button" class="btn btn-success btn-lg fw-bold" onclick="cobrarVenta(true)">üñ®Ô∏è IMPRIMIR Y COBRAR</button>
            </div>
        </div>
    </div>
</div>

<div id="ticket-print">
    <div style="text-align: center; margin-bottom: 10px;">
        <h3 style="margin:0;">LAS PRESAS DE UMA√ëITA</h3>
        <p style="margin:0;">Daniela Ariane Garcia Bravo</p>
        <p style="margin:0;">NIT: 1014259991-9</p>
        <p style="margin:0;">Calle Falsa 123 - Bogot√°</p>
        <hr style="border-top: 1px dashed black;">
    </div>
    <div style="font-size: 11px;">
        <strong>Fecha:</strong> <span id="print-fecha"></span><br>
        <strong>Mesa:</strong> <span id="print-mesa"></span><br>
        <strong>Cliente:</strong> <span id="print-cliente"></span><br>
        <strong>NIT/CC:</strong> <span id="print-nit"></span>
    </div>
    <hr style="border-top: 1px dashed black;">
    <table style="width: 100%; font-size: 11px;">
        <thead><tr><th align="left">Cant</th><th align="left">Desc</th><th align="right">Total</th></tr></thead>
        <tbody id="print-items"></tbody>
    </table>
    <hr style="border-top: 1px dashed black;">
    <div style="text-align: right;">Subtotal: <span id="print-subtotal"></span></div>
    <div style="text-align: right;">Desc: <span id="print-descuento"></span></div>
    <div style="text-align: right; font-weight: bold; font-size:14px;">TOTAL: <span id="print-total"></span></div>
    <hr style="border-top: 1px dashed black;">
    <div style="text-align: center; margin-top: 15px;">*** GRACIAS POR SU COMPRA ***</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let carrito = [];
    let mesaActual = 'Mostrador';
    
    document.addEventListener('DOMContentLoaded', () => {
        cargarMesasOcupadas();
        seleccionarMesa('Mostrador'); 
        
        document.querySelectorAll('.btn-agregar-producto').forEach(btn => {
            btn.addEventListener('click', function() {
                agregarAlCarrito(parseInt(this.dataset.id), this.dataset.nombre, parseInt(this.dataset.precio));
            });
        });
    });

    function cargarMesasOcupadas() {
        fetch('/ventas/mesas_ocupadas').then(r=>r.json()).then(data => {
            document.querySelectorAll('.mesa-btn').forEach(btn => btn.classList.remove('btn-warning'));
            data.mesas.forEach(m => {
                let btn = document.getElementById('btn-mesa-'+m);
                if(btn) {
                    btn.classList.remove('btn-outline-dark');
                    btn.classList.add('btn-warning');
                    btn.innerText = 'Mesa ' + m + ' (O)';
                }
            });
        });
    }

    function seleccionarMesa(mesa) {
        mesaActual = mesa;
        document.getElementById('mesa-actual').innerText = mesa;
        
        fetch('/ventas/obtener_mesa/' + mesa).then(r=>r.json()).then(data => {
            carrito = data.carrito || [];
            renderizarCarrito();
            document.querySelectorAll('.mesa-btn').forEach(b => b.classList.remove('mesa-activa'));
            let btn = document.getElementById('btn-mesa-'+mesa);
            if(btn) btn.classList.add('mesa-activa');
        });
    }

    function agregarAlCarrito(id, nombre, precio) {
        let precioFinal = precio;
        
        if (precio === 0) {
            let input = prompt("Ingrese el valor para " + nombre + ":");
            if (input === null || input.trim() === "") return;
            precioFinal = parseInt(input);
            if (isNaN(precioFinal) || precioFinal <= 0) {
                alert("Valor inv√°lido");
                return;
            }
        }

        let item = carrito.find(i => i.id === id && i.precio === precioFinal);
        
        if(item) {
            item.cantidad++;
        } else {
            carrito.push({id, nombre, precio: precioFinal, cantidad: 1});
        }
        renderizarCarrito();
    }

    function renderizarCarrito() {
        const tbody = document.getElementById('tabla-carrito');
        tbody.innerHTML = '';
        let total = 0, count = 0;
        carrito.forEach((item, idx) => {
            let sub = item.cantidad * item.precio;
            total += sub; count += item.cantidad;
            tbody.innerHTML += `<tr>
                <td>${item.nombre}</td>
                <td class="text-center"><div class="d-flex justify-content-center gap-1">
                    <button class="btn btn-outline-danger btn-cant btn-sm" onclick="upd(${idx}, -1)">-</button>
                    <span class="mx-1">${item.cantidad}</span>
                    <button class="btn btn-outline-success btn-cant btn-sm" onclick="upd(${idx}, 1)">+</button>
                </div></td>
                <td class="text-end fw-bold">$${sub.toLocaleString()}</td>
                <td class="text-end"><button class="btn btn-sm btn-link text-danger p-0" onclick="del(${idx})">x</button></td>
            </tr>`;
        });
        document.getElementById('total-pagar').innerText = '$' + total.toLocaleString();
        document.getElementById('modal-total').value = total; 
        document.getElementById('conteo-items').innerText = count;
    }

    function upd(i, d) { carrito[i].cantidad += d; if(carrito[i].cantidad<=0) carrito.splice(i,1); renderizarCarrito(); }
    function del(i) { carrito.splice(i,1); renderizarCarrito(); }
    function limpiarCarrito() { if(confirm('¬øLimpiar orden actual?')) { carrito=[]; renderizarCarrito(); } }

    function guardarEnMesa() {
        if(!carrito.length) return alert('Orden vac√≠a');
        fetch('/ventas/guardar_mesa', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ mesa: mesaActual, carrito: carrito })
        }).then(r=>r.json()).then(d => {
            alert('Orden guardada en ' + mesaActual);
            cargarMesasOcupadas(); 
            if(mesaActual === 'Mostrador') { carrito=[]; renderizarCarrito(); }
        });
    }

    function abrirModalPago() {
        if(!carrito.length) return alert('Vac√≠o');
        new bootstrap.Modal(document.getElementById('modalPago')).show();
        document.getElementById('input-recibido').value='';
        document.getElementById('input-descuento').value='0';
        document.getElementById('checkFantasma').checked = false;
        calcularVueltas();
        setTimeout(()=>document.getElementById('input-recibido').focus(), 500);
    }

    function calcularVueltas() {
        let subtotal = 0;
        carrito.forEach(i => subtotal += (i.precio * i.cantidad));
        
        let descuento = parseInt(document.getElementById('input-descuento').value) || 0;
        let totalFinal = subtotal - descuento;
        if(totalFinal < 0) totalFinal = 0;

        document.getElementById('lbl-subtotal').innerText = '$' + subtotal.toLocaleString();
        document.getElementById('lbl-descuento').innerText = '-$' + descuento.toLocaleString();
        document.getElementById('modal-total').value = totalFinal;

        let pago = (parseInt(document.getElementById('input-recibido').value)||0) + 
                   (parseInt(document.getElementById('pago-nequi').value)||0) + 
                   (parseInt(document.getElementById('pago-daviplata').value)||0);
                   
        let diff = pago - totalFinal;
        document.getElementById('txt-vueltas').innerText = diff >= 0 ? '$'+diff.toLocaleString() : 'Faltan: $'+(totalFinal-pago).toLocaleString();
        document.getElementById('info-vueltas').className = diff >= 0 ? 'alert alert-success text-center py-2' : 'alert alert-danger text-center py-2';
    }

    function cobrarVenta(imprimir) {
        let total = parseInt(document.getElementById('modal-total').value);
        let descuento = parseInt(document.getElementById('input-descuento').value) || 0;
        let pago = (parseInt(document.getElementById('input-recibido').value)||0) + 
                   (parseInt(document.getElementById('pago-nequi').value)||0) + 
                   (parseInt(document.getElementById('pago-daviplata').value)||0);

        if(pago < total) return alert('Pago insuficiente');

        if(imprimir) {
            document.getElementById('print-fecha').innerText = new Date().toLocaleString();
            document.getElementById('print-mesa').innerText = mesaActual;
            document.getElementById('print-cliente').innerText = document.getElementById('cli-nombre').value;
            document.getElementById('print-nit').innerText = document.getElementById('cli-nit').value;
            
            let tbody = document.getElementById('print-items'); tbody.innerHTML='';
            carrito.forEach(i => tbody.innerHTML+=`<tr><td>${i.cantidad}</td><td>${i.nombre}</td><td align="right">$${(i.precio*i.cantidad).toLocaleString()}</td></tr>`);
            
            document.getElementById('print-subtotal').innerText = '$' + (total + descuento).toLocaleString();
            document.getElementById('print-descuento').innerText = '$' + descuento.toLocaleString();
            document.getElementById('print-total').innerText = '$'+total.toLocaleString();
            window.print();
        }

        fetch('/ventas/cobrar', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                mesa: mesaActual,
                carrito, total, descuento,
                pagos: {
                    efectivo: parseInt(document.getElementById('input-recibido').value)||0, 
                    nequi: parseInt(document.getElementById('pago-nequi').value)||0, 
                    daviplata: parseInt(document.getElementById('pago-daviplata').value)||0
                },
                cambio: pago - total,
                cliente: {
                    nombre: document.getElementById('cli-nombre').value, 
                    nit: document.getElementById('cli-nit').value, 
                    telefono: document.getElementById('cli-tel').value, 
                    direccion: document.getElementById('cli-dir').value
                },
                es_fantasma: document.getElementById('checkFantasma').checked
            })
        }).then(r=>r.json()).then(d=>{
            if(d.status==='ok') {
                alert('Venta Registrada!');
                location.reload();
            } else {
                alert('Error: '+d.mensaje);
            }
        });
    }
</script>
</body>
</html>