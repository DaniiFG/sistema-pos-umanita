<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Informes Gerenciales</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f6f9; }
        .amount { font-family: 'Consolas', monospace; font-weight: bold; }
        .filtro-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        /* Estilo para la lista bonita de productos */
        .product-list-box {
            max-height: 120px; 
            overflow-y: auto; 
            background: #fff; 
            border: 1px solid #ced4da; 
            border-radius: 4px;
            padding: 5px;
        }
        .form-check-sm { min-height: 1.2rem; margin-bottom: 0.2rem; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 px-3">
    <a class="navbar-brand fw-bold" href="#">üìä Reportes Uma√±ita</a>
    <div class="ms-auto">
        <a href="/ventas" class="btn btn-sm btn-outline-light">Ir a Ventas</a>
        <a href="/gastos" class="btn btn-sm btn-outline-light">Ir a Gastos</a>
    </div>
</nav>

<div class="container pb-5">
    
    <button class="btn btn-sm btn-outline-secondary mb-2" onclick="toggleFiltros()">üëÅÔ∏è Mostrar/Ocultar Filtros</button>
    
    <div class="filtro-box" id="box-filtros">
        <form method="POST" id="formFiltros">
            <input type="hidden" name="tab_activa" id="inputTabActiva" value="{{ tab_activa }}">
            
            <div class="row g-2 align-items-end mb-2">
                <div class="col-md-3">
                    <label class="small fw-bold">Desde</label>
                    <input type="date" name="fecha_inicio" id="input-fecha-inicio" class="form-control form-control-sm" value="{{ f_inicio }}">
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold">Hasta</label>
                    <input type="date" name="fecha_fin" id="input-fecha-fin" class="form-control form-control-sm" value="{{ f_fin }}">
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold">M√©todo Pago</label>
                    <select name="filtro_metodo" id="input-metodo-pago" class="form-select form-select-sm">
                        <option value="">Todos</option>
                        <option value="Efectivo" {% if filtro_metodo=='Efectivo' %}selected{% endif %}>Efectivo</option>
                        <option value="Nequi" {% if filtro_metodo=='Nequi' %}selected{% endif %}>Nequi</option>
                        <option value="Daviplata" {% if filtro_metodo=='Daviplata' %}selected{% endif %}>Daviplata</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex gap-1">
                    <button type="submit" class="btn btn-primary btn-sm w-100 fw-bold"><i class="fas fa-filter"></i> APLICAR</button>
                    <a href="/informes" class="btn btn-outline-danger btn-sm w-50" title="Borrar Filtros">X</a>
                </div>
            </div>
            <hr class="my-2">
            <div class="row g-2">
                <div class="col-md-2">
                    <label class="small text-muted">Cat. Producto</label>
                    <select name="filtro_categoria_prod" id="input-cat-prod" class="form-select form-select-sm">
                        <option value="">Todas</option>
                        {% for c in cats_prod %}<option value="{{ c }}" {% if filtro_cat_prod==c %}selected{% endif %}>{{ c }}</option>{% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="small text-muted">Productos Espec√≠ficos</label>
                    <div class="product-list-box">
                        {% for p in list_prod %}
                        <div class="form-check form-check-sm">
                            <input class="form-check-input chk-prod-filtro" type="checkbox" 
                                   name="filtro_producto_especifico" 
                                   value="{{ p }}" 
                                   id="chk-prod-{{ loop.index }}" 
                                   {% if p in filtro_prod_esp %}checked{% endif %}>
                            <label class="form-check-label small w-100 text-truncate" for="chk-prod-{{ loop.index }}" title="{{ p }}">
                                {{ p }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="col-md-2 border-start ps-3">
                    <label class="small text-muted">Cat. Gasto</label>
                    <select name="filtro_categoria_gasto" id="input-cat-gasto" class="form-select form-select-sm">
                        <option value="">Todas</option>
                        {% for c in cats_gasto %}<option value="{{ c }}" {% if filtro_cat_gasto==c %}selected{% endif %}>{{ c }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="small text-muted">Concepto Gasto</label>
                    <select name="filtro_concepto" id="input-concepto" class="form-select form-select-sm">
                        <option value="">Todos</option>
                        {% for c in list_conceptos %}<option value="{{ c }}" {% if filtro_con==c %}selected{% endif %}>{{ c }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="small text-muted">Proveedor</label>
                    <select name="filtro_proveedor" id="input-proveedor" class="form-select form-select-sm">
                        <option value="">Todos</option>
                        {% for p in list_prov %}<option value="{{ p.id }}" {% if filtro_prov==p.id|string %}selected{% endif %}>{{ p.nombre }}</option>{% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </div>

    <ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
        <li class="nav-item"><button class="nav-link fw-bold" id="tab-ventas" data-bs-toggle="tab" data-bs-target="#ventas" onclick="setTab('ventas')">1. VENTAS</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" id="tab-gastos" data-bs-toggle="tab" data-bs-target="#gastos" onclick="setTab('gastos')">2. GASTOS</button></li>
        <li class="nav-item"><button class="nav-link fw-bold text-success" id="tab-balance" data-bs-toggle="tab" data-bs-target="#balance" onclick="setTab('balance')">3. CIERRE CAJA</button></li>
        <li class="nav-item"><button class="nav-link fw-bold text-dark" id="tab-pyg" data-bs-toggle="tab" data-bs-target="#pyg" onclick="setTab('pyg')">4. P & G</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade" id="ventas">
            <h4 class="text-primary fw-bold mb-3">Total Ventas (Filtrado): <span class="badge bg-primary">${{ "{:,.0f}".format(total_ventas) }}</span></h4>
            
            <div class="d-flex gap-2 mb-3">
                <button class="btn btn-outline-success btn-sm" onclick="generarReporteVentas('contable')"><i class="fas fa-file-invoice"></i> Reporte Contable</button>
                <button class="btn btn-outline-primary btn-sm" onclick="generarReporteVentas('detallado')"><i class="fas fa-list-ul"></i> Reporte Detallado</button>
                <button class="btn btn-outline-info btn-sm" onclick="generarReporteVentas('general')"><i class="fas fa-box"></i> Reporte General</button>
            </div>
            
            <div class="row">
                <div class="col-md-7">
                    <div class="chart-container">
                        <canvas id="chartVentas"></canvas>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="card shadow-sm h-100 table-responsive" style="max-height:350px;">
                        <table class="table table-sm table-striped">
                            <thead><tr><th>Producto</th><th>Cant</th><th>Total</th></tr></thead>
                            <tbody>
                                {% for p in productos %}
                                <tr><td>{{ p.nombre }}</td><td>{{ p.cant }}</td><td class="text-end fw-bold">${{ "{:,.0f}".format(p.dinero) }}</td></tr>
                                {% else %}
                                <tr><td colspan="3" class="text-center text-muted">No hay datos para mostrar</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="gastos">
            <h4 class="text-danger fw-bold mb-3">Total Gastos (Filtrado): <span class="badge bg-danger">${{ "{:,.0f}".format(total_gastos) }}</span></h4>

            <div class="d-flex gap-2 mb-3">
                <button class="btn btn-outline-success btn-sm" onclick="generarReporteGastos('contable')"><i class="fas fa-file-invoice"></i> Reporte Contable</button>
                <button class="btn btn-outline-primary btn-sm" onclick="generarReporteGastos('detallado')"><i class="fas fa-list-ul"></i> Reporte Detallado</button>
                <button class="btn btn-outline-info btn-sm" onclick="generarReporteGastos('general')"><i class="fas fa-box"></i> Reporte General</button>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="chartGastos"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100 table-responsive" style="max-height:350px;">
                        <table class="table table-sm table-hover">
                            <thead><tr><th>Fecha</th><th>Concepto</th><th>$$</th></tr></thead>
                            <tbody>
                                {% for g in lista_gastos %}
                                <tr>
                                    <td>{{ g.fecha.strftime('%d/%m') }}</td>
                                    <td>{{ g.descripcion }}<br><small class="text-muted">{{ g.metodo_pago }}</small></td>
                                    <td class="text-end text-danger">${{ "{:,.0f}".format(g.monto) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="balance">
            <div class="row">
                <div class="col-md-4"><div class="card border-success mb-3"><div class="card-body text-center"><h5 class="text-success">Efectivo en Mano</h5><h2 class="amount">${{ "{:,.0f}".format(cierre_efectivo) }}</h2></div></div></div>
                <div class="col-md-4"><div class="card border-primary mb-3"><div class="card-body text-center"><h5 class="text-primary">Saldo Nequi</h5><h2 class="amount">${{ "{:,.0f}".format(cierre_nequi) }}</h2></div></div></div>
                <div class="col-md-4"><div class="card border-danger mb-3"><div class="card-body text-center"><h5 class="text-danger">Saldo Daviplata</h5><h2 class="amount">${{ "{:,.0f}".format(cierre_davi) }}</h2></div></div></div>
            </div>

            <div class="accordion" id="accordionBalance">
                <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#detVentas">üìú Ver Detalle Ingresos (Ventas + Extra)</button></h2>
                    <div id="detVentas" class="accordion-collapse collapse" data-bs-parent="#accordionBalance">
                        <div class="accordion-body p-0 table-responsive" style="max-height:300px;">
                            <table class="table table-sm table-striped mb-0">
                                <thead><tr><th>Hora</th><th>Tipo</th><th>Pagos</th><th>Total</th></tr></thead>
                                <tbody>
                                    {% for o in detalles_otros %}
                                    <tr class="table-warning">
                                        <td>{{ o.fecha.strftime('%d/%m') }}</td>
                                        <td><strong>EXTRA:</strong> {{ o.origen }}</td>
                                        <td class="small">{{ o.descripcion }}</td>
                                        <td class="fw-bold text-success">+${{ o.monto }}</td>
                                    </tr>
                                    {% endfor %}
                                    {% for v in detalles_ventas %}
                                    <tr>
                                        <td>{{ v.fecha.strftime('%H:%M') }}</td>
                                        <td>{{ 'Domicilio' if v.es_domicilio else 'Mesa' }}</td>
                                        <td class="small">Ef:{{v.pago_efectivo}} Nq:{{v.pago_nequi}} Dv:{{v.pago_daviplata}}</td>
                                        <td class="fw-bold">${{v.total_venta}}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#detGastos">üìâ Ver Detalle Egresos</button></h2>
                    <div id="detGastos" class="accordion-collapse collapse" data-bs-parent="#accordionBalance">
                        <div class="accordion-body p-0 table-responsive" style="max-height:300px;">
                            <table class="table table-sm table-hover mb-0">
                                <thead><tr><th>Fecha</th><th>Desc</th><th>Pago</th><th>Monto</th></tr></thead>
                                <tbody>
                                    {% for g in detalles_gastos %}
                                    <tr>
                                        <td>{{ g.fecha.strftime('%d/%m') }}</td>
                                        <td>{{ g.descripcion }}</td>
                                        <td>{{ g.metodo_pago }}</td>
                                        <td class="text-danger">${{ g.monto }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pyg">
            <div class="d-flex justify-content-end mb-3">
                 <button class="btn btn-outline-dark btn-sm" onclick="generarReportePyg()">üñ®Ô∏è Imprimir Informe</button>
            </div>
            <div class="alert alert-info py-2"><i class="fas fa-info-circle"></i> C√°lculo de rentabilidad aproximada seg√∫n costos de referencia.</div>
            <table class="table table-bordered bg-white">
                <tr><td class="fw-bold">Ingresos</td><td class="text-end">${{ "{:,.0f}".format(total_ventas) }}</td></tr>
                <tr><td class="fw-bold text-danger">(-) Costo Venta</td><td class="text-end text-danger">-${{ "{:,.0f}".format(costo_ventas) }}</td></tr>
                <tr class="table-secondary"><td class="fw-bold">(=) Utilidad Bruta</td><td class="text-end fw-bold">${{ "{:,.0f}".format(utilidad_bruta) }}</td></tr>
                <tr><td class="fw-bold text-danger">(-) Gastos Operativos</td><td class="text-end text-danger">-${{ "{:,.0f}".format(total_gastos) }}</td></tr>
                <tr class="table-success"><td class="fw-bold fs-5">(=) Utilidad Neta</td><td class="text-end fw-bold fs-5">${{ "{:,.0f}".format(utilidad_neta) }}</td></tr>
            </table>
        </div>
    </div>
</div>

<form id="formReporte" method="POST" target="_blank">
    <input type="hidden" name="fecha_inicio" id="report-fecha-inicio">
    <input type="hidden" name="fecha_fin" id="report-fecha-fin">
    <input type="hidden" name="filtro_metodo" id="report-filtro-metodo">
    <input type="hidden" name="filtro_categoria_prod" id="report-filtro-cat-prod">
    <input type="hidden" name="filtro_categoria_gasto" id="report-filtro-cat-gasto">
    <input type="hidden" name="filtro_concepto" id="report-filtro-concepto">
    <input type="hidden" name="filtro_proveedor" id="report-filtro-proveedor">
</form>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var activeTab = document.getElementById('inputTabActiva').value || 'ventas';
        var triggerEl = document.querySelector('#tab-' + activeTab);
        if(triggerEl) new bootstrap.Tab(triggerEl).show();
    });

    function setTab(tabName) {
        document.getElementById('inputTabActiva').value = tabName;
    }

    function toggleFiltros() {
        const box = document.getElementById('box-filtros');
        box.style.display = (box.style.display === 'none') ? 'block' : 'none';
    }
    
    function getFiltros() {
        const checkboxes = document.querySelectorAll('.chk-prod-filtro:checked');
        const selectedProducts = Array.from(checkboxes).map(chk => chk.value);

        return {
            fecha_inicio: document.getElementById('input-fecha-inicio').value,
            fecha_fin: document.getElementById('input-fecha-fin').value,
            filtro_metodo: document.getElementById('input-metodo-pago').value,
            filtro_categoria_prod: document.getElementById('input-cat-prod').value,
            filtro_producto_especifico: selectedProducts, 
            filtro_categoria_gasto: document.getElementById('input-cat-gasto').value,
            filtro_concepto: document.getElementById('input-concepto').value,
            filtro_proveedor: document.getElementById('input-proveedor').value
        };
    }

    function setupReporteForm(filtros) {
        const form = document.getElementById('formReporte');
        Array.from(form.querySelectorAll('input[name="filtro_producto_especifico"]')).forEach(input => input.remove());

        document.getElementById('report-fecha-inicio').value = filtros.fecha_inicio;
        document.getElementById('report-fecha-fin').value = filtros.fecha_fin;
        document.getElementById('report-filtro-metodo').value = filtros.filtro_metodo;
        document.getElementById('report-filtro-cat-prod').value = filtros.filtro_categoria_prod;
        
        filtros.filtro_producto_especifico.forEach(val => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'filtro_producto_especifico';
            input.value = val;
            form.appendChild(input);
        });

        document.getElementById('report-filtro-cat-gasto').value = filtros.filtro_categoria_gasto;
        document.getElementById('report-filtro-concepto').value = filtros.filtro_concepto;
        document.getElementById('report-filtro-proveedor').value = filtros.filtro_proveedor;
    }

    function generarReporteVentas(tipo) {
        const filtros = getFiltros();
        setupReporteForm(filtros);
        const form = document.getElementById('formReporte');
        form.action = '/informes/reporte_ventas/' + tipo;
        form.submit();
    }
    
    function generarReporteGastos(tipo) {
        const filtros = getFiltros();
        setupReporteForm(filtros);
        const form = document.getElementById('formReporte');
        form.action = '/informes/reporte_gastos/' + tipo;
        form.submit();
    }
    
    function generarReportePyg() {
        const filtros = getFiltros();
        setupReporteForm(filtros);
        const form = document.getElementById('formReporte');
        form.action = '/informes/reporte_pyg';
        form.submit();
    }

    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false, 
    };

    new Chart(document.getElementById('chartVentas'), {
        type: 'doughnut',
        data: { labels: {{ labels_ventas | tojson }}, datasets: [{ data: {{ data_ventas | tojson }}, backgroundColor: ['#0d6efd','#198754','#ffc107','#dc3545','#6610f2'] }] },
        options: commonOptions
    });
    new Chart(document.getElementById('chartGastos'), {
        type: 'bar',
        data: { labels: {{ labels_gastos | tojson }}, datasets: [{ label:'Gastos', data: {{ data_gastos | tojson }}, backgroundColor: '#dc3545' }] },
        options: { indexAxis: 'y', ...commonOptions }
    });
</script>
</body>
</html>