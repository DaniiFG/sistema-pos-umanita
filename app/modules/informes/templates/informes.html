<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Informes Gerenciales</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f6f9; }
        .amount { font-family: 'Consolas', monospace; font-weight: bold; }
        .filtro-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 px-3">
    <a class="navbar-brand fw-bold" href="#">üìä Reportes Uma√±ita</a>
    <div class="ms-auto">
        <a href="/ventas" class="btn btn-sm btn-outline-light">Ir a Ventas</a>
        <a href="/gastos" class="btn btn-sm btn-outline-light">Ir a Gastos</a>
    </div>
</nav>

<div class="container pb-5">
    
    <button class="btn btn-sm btn-outline-secondary mb-2" onclick="toggleFiltros()">üëÅÔ∏è Mostrar/Ocultar Filtros</button>
    
    <div class="filtro-box" id="box-filtros">
        <form method="POST" id="formFiltros">
            <input type="hidden" name="tab_activa" id="inputTabActiva" value="{{ tab_activa }}">
            
            <div class="row g-2 align-items-end mb-2">
                <div class="col-md-3">
                    <label class="small fw-bold">Desde</label>
                    <input type="date" name="fecha_inicio" class="form-control form-control-sm" value="{{ f_inicio }}">
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold">Hasta</label>
                    <input type="date" name="fecha_fin" class="form-control form-control-sm" value="{{ f_fin }}">
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold">M√©todo Pago</label>
                    <select name="filtro_metodo" class="form-select form-select-sm">
                        <option value="">Todos</option>
                        <option value="Efectivo" {% if filtro_metodo=='Efectivo' %}selected{% endif %}>Efectivo</option>
                        <option value="Nequi" {% if filtro_metodo=='Nequi' %}selected{% endif %}>Nequi</option>
                        <option value="Daviplata" {% if filtro_metodo=='Daviplata' %}selected{% endif %}>Daviplata</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex gap-1">
                    <button type="submit" class="btn btn-primary btn-sm w-100 fw-bold"><i class="fas fa-filter"></i> APLICAR</button>
                    <a href="/informes" class="btn btn-outline-danger btn-sm w-50" title="Borrar Filtros">X</a>
                </div>
            </div>
            <hr class="my-2">
            <div class="row g-2">
                <div class="col-md-2">
                    <label class="small text-muted">Cat. Producto</label>
                    <select name="filtro_categoria_prod" class="form-select form-select-sm">
                        <option value="">Todas</option>
                        {% for c in cats_prod %}<option value="{{ c }}" {% if filtro_cat_prod==c %}selected{% endif %}>{{ c }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="small text-muted">Producto Espec√≠fico</label>
                    <select name="filtro_producto_especifico" class="form-select form-select-sm">
                        <option value="">Todos</option>
                        {% for p in list_prod %}<option value="{{ p }}" {% if filtro_prod_esp==p %}selected{% endif %}>{{ p }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-2 border-start ps-3">
                    <label class="small text-muted">Cat. Gasto</label>
                    <select name="filtro_categoria_gasto" class="form-select form-select-sm">
                        <option value="">Todas</option>
                        {% for c in cats_gasto %}<option value="{{ c }}" {% if filtro_cat_gasto==c %}selected{% endif %}>{{ c }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="small text-muted">Concepto Gasto</label>
                    <select name="filtro_concepto" class="form-select form-select-sm">
                        <option value="">Todos</option>
                        {% for c in list_conceptos %}<option value="{{ c }}" {% if filtro_con==c %}selected{% endif %}>{{ c }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="small text-muted">Proveedor</label>
                    <select name="filtro_proveedor" class="form-select form-select-sm">
                        <option value="">Todos</option>
                        {% for p in list_prov %}<option value="{{ p.id }}" {% if filtro_prov==p.id|string %}selected{% endif %}>{{ p.nombre }}</option>{% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </div>

    <ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
        <li class="nav-item"><button class="nav-link fw-bold" id="tab-ventas" data-bs-toggle="tab" data-bs-target="#ventas" onclick="setTab('ventas')">1. VENTAS</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" id="tab-gastos" data-bs-toggle="tab" data-bs-target="#gastos" onclick="setTab('gastos')">2. GASTOS</button></li>
        <li class="nav-item"><button class="nav-link fw-bold text-success" id="tab-balance" data-bs-toggle="tab" data-bs-target="#balance" onclick="setTab('balance')">3. CIERRE CAJA</button></li>
        <li class="nav-item"><button class="nav-link fw-bold text-dark" id="tab-pyg" data-bs-toggle="tab" data-bs-target="#pyg" onclick="setTab('pyg')">4. P & G</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade" id="ventas">
            <h4 class="text-primary fw-bold mb-3">Total Ventas (Filtrado): <span class="badge bg-primary">${{ "{:,.0f}".format(total_ventas) }}</span></h4>
            <div class="row">
                <div class="col-md-7"><canvas id="chartVentas" style="max-height: 300px;"></canvas></div>
                <div class="col-md-5">
                    <div class="card shadow-sm h-100 table-responsive" style="max-height:350px;">
                        <table class="table table-sm table-striped">
                            <thead><tr><th>Producto</th><th>Cant</th><th>Total</th></tr></thead>
                            <tbody>
                                {% for p in productos %}
                                <tr><td>{{ p.nombre }}</td><td>{{ p.cant }}</td><td class="text-end fw-bold">${{ "{:,.0f}".format(p.dinero) }}</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="gastos">
            <h4 class="text-danger fw-bold mb-3">Total Gastos (Filtrado): <span class="badge bg-danger">${{ "{:,.0f}".format(total_gastos) }}</span></h4>
            <div class="row">
                <div class="col-md-6"><canvas id="chartGastos" style="max-height: 300px;"></canvas></div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100 table-responsive" style="max-height:350px;">
                        <table class="table table-sm table-hover">
                            <thead><tr><th>Fecha</th><th>Concepto</th><th>$$</th></tr></thead>
                            <tbody>
                                {% for g in lista_gastos %}
                                <tr>
                                    <td>{{ g.fecha.strftime('%d/%m') }}</td>
                                    <td>{{ g.descripcion }}<br><small class="text-muted">{{ g.metodo_pago }}</small></td>
                                    <td class="text-end text-danger">${{ "{:,.0f}".format(g.monto) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="balance">
            <div class="row">
                <div class="col-md-4">
                    <div class="card border-success mb-3">
                        <div class="card-body text-center">
                            <h5 class="text-success">Efectivo en Mano</h5>
                            <h2 class="amount">${{ "{:,.0f}".format(cierre_efectivo) }}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-primary mb-3">
                        <div class="card-body text-center">
                            <h5 class="text-primary">Saldo Nequi</h5>
                            <h2 class="amount">${{ "{:,.0f}".format(cierre_nequi) }}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-danger mb-3">
                        <div class="card-body text-center">
                            <h5 class="text-danger">Saldo Daviplata</h5>
                            <h2 class="amount">${{ "{:,.0f}".format(cierre_davi) }}</h2>
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion" id="accordionBalance">
                <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#detVentas">üìú Ver Detalle Ingresos (Ventas + Extra)</button></h2>
                    <div id="detVentas" class="accordion-collapse collapse" data-bs-parent="#accordionBalance">
                        <div class="accordion-body p-0 table-responsive" style="max-height:300px;">
                            <table class="table table-sm table-striped mb-0">
                                <thead><tr><th>Hora</th><th>Tipo</th><th>Pagos</th><th>Total</th></tr></thead>
                                <tbody>
                                    {% for o in detalles_otros %}
                                    <tr class="table-warning">
                                        <td>{{ o.fecha.strftime('%d/%m') }}</td>
                                        <td><strong>EXTRA:</strong> {{ o.origen }}</td>
                                        <td class="small">{{ o.descripcion }}</td>
                                        <td class="fw-bold text-success">+${{ o.monto }}</td>
                                    </tr>
                                    {% endfor %}

                                    {% for v in detalles_ventas %}
                                    <tr>
                                        <td>{{ v.fecha.strftime('%H:%M') }}</td>
                                        <td>{{ 'Domicilio' if v.es_domicilio else 'Mesa' }}</td>
                                        <td class="small">Ef:{{v.pago_efectivo}} Nq:{{v.pago_nequi}} Dv:{{v.pago_daviplata}}</td>
                                        <td class="fw-bold">${{v.total_venta}}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#detGastos">üìâ Ver Detalle Egresos</button></h2>
                    <div id="detGastos" class="accordion-collapse collapse" data-bs-parent="#accordionBalance">
                        <div class="accordion-body p-0 table-responsive" style="max-height:300px;">
                            <table class="table table-sm table-hover mb-0">
                                <thead><tr><th>Fecha</th><th>Desc</th><th>Pago</th><th>Monto</th></tr></thead>
                                <tbody>
                                    {% for g in detalles_gastos %}
                                    <tr>
                                        <td>{{ g.fecha.strftime('%d/%m') }}</td>
                                        <td>{{ g.descripcion }}</td>
                                        <td>{{ g.metodo_pago }}</td>
                                        <td class="text-danger">${{ g.monto }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pyg">
            <div class="alert alert-info py-2"><i class="fas fa-info-circle"></i> C√°lculo de rentabilidad aproximada seg√∫n costos de referencia.</div>
            <table class="table table-bordered bg-white">
                <tr><td class="fw-bold">Ingresos</td><td class="text-end">${{ "{:,.0f}".format(total_ventas) }}</td></tr>
                <tr><td class="fw-bold text-danger">(-) Costo Venta</td><td class="text-end text-danger">-${{ "{:,.0f}".format(costo_ventas) }}</td></tr>
                <tr class="table-secondary"><td class="fw-bold">(=) Utilidad Bruta</td><td class="text-end fw-bold">${{ "{:,.0f}".format(utilidad_bruta) }}</td></tr>
                <tr><td class="fw-bold text-danger">(-) Gastos Operativos</td><td class="text-end text-danger">-${{ "{:,.0f}".format(total_gastos) }}</td></tr>
                <tr class="table-success"><td class="fw-bold fs-5">(=) Utilidad Neta</td><td class="text-end fw-bold fs-5">${{ "{:,.0f}".format(utilidad_neta) }}</td></tr>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var activeTab = document.getElementById('inputTabActiva').value || 'ventas';
        var triggerEl = document.querySelector('#tab-' + activeTab);
        if(triggerEl) new bootstrap.Tab(triggerEl).show();
    });

    function setTab(tabName) {
        document.getElementById('inputTabActiva').value = tabName;
    }

    function toggleFiltros() {
        const box = document.getElementById('box-filtros');
        box.style.display = (box.style.display === 'none') ? 'block' : 'none';
    }

    new Chart(document.getElementById('chartVentas'), {
        type: 'doughnut',
        data: { labels: {{ labels_ventas | tojson }}, datasets: [{ data: {{ data_ventas | tojson }}, backgroundColor: ['#0d6efd','#198754','#ffc107','#dc3545','#6610f2'] }] }
    });
    new Chart(document.getElementById('chartGastos'), {
        type: 'bar',
        data: { labels: {{ labels_gastos | tojson }}, datasets: [{ label:'Gastos', data: {{ data_gastos | tojson }}, backgroundColor: '#dc3545' }] },
        options: { indexAxis: 'y' }
    });
</script>
</body>
</html>